import{a as pe}from"./chunk-MVPRFZGE.js";import{a as _e}from"./chunk-4HM5KGBB.js";import{a as ue}from"./chunk-M774G3SU.js";import{e as w}from"./chunk-UI373YL4.js";import{a as W,b as X,c as Z,d as ee,e as te,f as ae,g as ie,h as ne,i as re,j as oe,k as ce,l as le}from"./chunk-OJYR24EB.js";import{a as me}from"./chunk-TVMSW2JO.js";import"./chunk-Y7FYPZNW.js";import"./chunk-A3A72ILT.js";import"./chunk-CUKNIT7M.js";import{a as G}from"./chunk-AY56TXUB.js";import{a as se,b as de}from"./chunk-6AWQUBPH.js";import"./chunk-VMH4ILIM.js";import{a as j}from"./chunk-XOQFDSMO.js";import"./chunk-JLIX64RS.js";import{c as K}from"./chunk-VORQTW3B.js";import"./chunk-FVBRAVME.js";import{a as z,c as U}from"./chunk-L2D7AHNW.js";import"./chunk-POHCU53O.js";import{a as J,e as Q}from"./chunk-6QI4QBU5.js";import"./chunk-DXFFT4B6.js";import{a as q}from"./chunk-UJ255QIO.js";import"./chunk-MXV4M2BO.js";import"./chunk-4N6BO7AP.js";import"./chunk-RU375CWH.js";import"./chunk-KXJUWRJT.js";import"./chunk-SB5MWYDA.js";import"./chunk-EMZRNCIP.js";import"./chunk-DKHW3YWA.js";import{t as H}from"./chunk-2T5SWUVG.js";import{$b as D,Cb as c,Db as l,Eb as S,Fb as v,Gb as A,Ib as P,Nb as O,Pb as C,T as k,Wa as g,Xa as M,Zb as u,f as T,gc as N,ha as F,ic as R,mb as h,qa as y,qb as V,ra as Y,rb as b,v as I,xb as $}from"./chunk-NSU275EB.js";import{a as B,b as L}from"./chunk-ODN5LVDJ.js";var fe=i=>({academicYear:i});function he(i,s){i&1&&(c(0,"div",1),S(1,"app-loading"),l())}function Ce(i,s){i&1&&(c(0,"th",20),u(1," # "),l())}function ye(i,s){if(i&1&&(c(0,"td",21),u(1),l()),i&2){let e=s.index;g(),D(" ",e+1," ")}}function Ye(i,s){i&1&&(c(0,"th",22),u(1," Program Code "),l())}function be(i,s){if(i&1&&(c(0,"td",23),u(1),l()),i&2){let e=s.$implicit;g(),D(" ",e.program_code," ")}}function ve(i,s){i&1&&(c(0,"th",22),u(1," Program Title "),l())}function Ae(i,s){if(i&1&&(c(0,"td",23),u(1),l()),i&2){let e=s.$implicit;g(),D(" ",e.program_title," ")}}function xe(i,s){i&1&&(c(0,"th",22),u(1," Year Levels "),l())}function Me(i,s){if(i&1){let e=P();c(0,"td",23)(1,"button",24),O("click",function(){let t=y(e).$implicit,n=C(2);return Y(n.onManageYearLevels(t))}),c(2,"mat-icon"),u(3,"school"),l(),c(4,"span"),u(5,"Edit Year Levels"),l()()()}}function Se(i,s){i&1&&(c(0,"th",22),u(1," Sections "),l())}function Pe(i,s){if(i&1){let e=P();c(0,"td",23)(1,"button",24),O("click",function(){let t=y(e).$implicit,n=C(2);return Y(n.onManageSections(t))}),c(2,"mat-icon"),u(3,"view_list"),l(),c(4,"span"),u(5,"Edit Sections"),l()()()}}function Oe(i,s){i&1&&(c(0,"th",22),u(1," Action "),l())}function we(i,s){if(i&1){let e=P();c(0,"td",23)(1,"button",25),O("click",function(){let t=y(e).$implicit,n=C(2);return Y(n.onRemoveProgram(t))}),c(2,"mat-icon"),u(3,"delete"),l(),c(4,"span"),u(5,"Remove"),l()()()}}function Ee(i,s){i&1&&S(0,"tr",26)}function ke(i,s){i&1&&S(0,"tr",27)}function De(i,s){if(i&1&&(c(0,"tr")(1,"td",28)(2,"div",29)(3,"div",30),S(4,"span",31),c(5,"span"),u(6," No programs found for this academic year."),l()()()()()),i&2){let e=C(2);g(),V("colspan",e.displayedColumns.length)}}function Ie(i,s){if(i&1){let e=P();c(0,"div",2)(1,"app-table-header",3),O("inputChange",function(t){y(e);let n=C();return Y(n.onInputChange(t))})("add",function(){y(e);let t=C();return Y(t.openManageAcademicYearDialog())})("addAcademicYear",function(){y(e);let t=C();return Y(t.openAddAcademicYearDialog())}),l()(),c(2,"div",4)(3,"div",5)(4,"table",6),v(5,7),h(6,Ce,2,0,"th",8)(7,ye,2,1,"td",9),A(),v(8,10),h(9,Ye,2,0,"th",11)(10,be,2,1,"td",12),A(),v(11,13),h(12,ve,2,0,"th",11)(13,Ae,2,1,"td",12),A(),v(14,14),h(15,xe,2,0,"th",11)(16,Me,6,0,"td",12),A(),v(17,15),h(18,Se,2,0,"th",11)(19,Pe,6,0,"td",12),A(),v(20,16),h(21,Oe,2,0,"th",11)(22,we,6,0,"td",12),A(),h(23,Ee,1,0,"tr",17)(24,ke,1,0,"tr",18)(25,De,7,1,"tr",19),l()()()}if(i&2){let e=C();b("@fadeAnimation",void 0),g(),b("inputFields",e.headerInputFields)("showExportButton",!1)("showAddButton",!0)("addButtonLabel","Manage Academic Years")("addIconName","apps")("showActiveYearAndSem",!1)("showButtons",!0)("selectedValues",R(13,fe,e.selectedAcademicYear)),g(),b("@fadeAnimation",void 0),g(2),b("dataSource",e.programs),g(19),b("matHeaderRowDef",e.displayedColumns),g(),b("matRowDefColumns",e.displayedColumns)}}var Ze=(()=>{class i{dialog;snackBar;schedulingService;curriculumService;programs=[];academicYearOptions=[];selectedAcademicYear="";selectedAcademicYearId=null;destroy$=new T;isLoading=!0;headerInputFields=[{type:"select",label:"Academic Year",key:"academicYear",options:[]}];displayedColumns=["index","program_code","program_title","year_levels","sections","action"];constructor(e,a,t,n){this.dialog=e,this.snackBar=a,this.schedulingService=t,this.curriculumService=n}ngOnInit(){this.loadData()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}loadData(){this.isLoading=!0,I({academicYears:this.schedulingService.getAcademicYears(),activeYear:this.schedulingService.getActiveYearAndSemester()}).pipe(k(this.destroy$)).subscribe(({academicYears:e,activeYear:a})=>{this.academicYearOptions=e.map(n=>({academic_year_id:n.academic_year_id,academic_year:n.academic_year})),this.headerInputFields[0].options=this.academicYearOptions.map(n=>n.academic_year);let t=this.academicYearOptions.find(n=>n.academic_year===a.activeYear);if(t)this.selectedAcademicYear=t.academic_year,this.selectedAcademicYearId=t.academic_year_id;else if(this.academicYearOptions.length>0){let n=this.academicYearOptions[0].academic_year,d=this.academicYearOptions[0].academic_year_id;this.selectedAcademicYear=n,this.selectedAcademicYearId=d}else{this.isLoading=!1,this.snackBar.open("No academic years available.","Close",{duration:3e3});return}this.fetchProgramsForAcademicYear(this.selectedAcademicYear)},e=>{this.isLoading=!1,console.error("Error loading data:",e),this.snackBar.open("Failed to load data.","Close",{duration:3e3})})}loadAcademicYears(){this.schedulingService.getAcademicYears().pipe(k(this.destroy$)).subscribe(e=>{if(this.academicYearOptions=e.map(a=>({academic_year_id:a.academic_year_id,academic_year:a.academic_year})),this.headerInputFields[0].options=this.academicYearOptions.map(a=>a.academic_year),this.academicYearOptions.length>0){let a=this.academicYearOptions[0].academic_year,t=this.academicYearOptions[0].academic_year_id;this.selectedAcademicYear=a,this.selectedAcademicYearId=t,this.fetchProgramsForAcademicYear(a)}else this.snackBar.open("No academic years available.","Close",{duration:3e3})},e=>{console.error("Error loading academic years:",e),this.snackBar.open("Failed to load academic years.","Close",{duration:3e3})})}fetchProgramsForAcademicYear(e){let a=this.academicYearOptions.find(t=>t.academic_year===e);if(!a){this.isLoading=!1;return}this.selectedAcademicYearId=a.academic_year_id,this.schedulingService.fetchProgramDetailsByAcademicYear({academic_year_id:a.academic_year_id}).pipe(k(this.destroy$)).subscribe(t=>{t.programs&&(this.programs=t.programs.map(n=>({program_id:n.program_id,program_code:n.program_code,program_title:n.program_title,year_levels:n.year_levels,sections:this.getSectionsByProgram(n)}))),this.isLoading=!1},t=>{this.isLoading=!1,console.error("Error fetching program details: ",t),this.snackBar.open("Failed to fetch program details.","Close",{duration:3e3})})}getSectionsByProgram(e){let a={};return e.year_levels.forEach(t=>{a[t.year_level]=t.number_of_sections}),a}onInputChange(e){e.academicYear&&(this.selectedAcademicYear=e.academicYear,this.fetchProgramsForAcademicYear(this.selectedAcademicYear))}onManageYearLevels(e){let a=[];console.log("Fetched Program ID:",e.program_id),this.curriculumService.getCurricula().subscribe(t=>{console.log(t);let n=t.map(o=>({year:o.curriculum_year,id:o.curriculum_id})),d=e.year_levels.sort((o,p)=>o.year_level-p.year_level);if(!Array.isArray(e.year_levels)){console.error("Expected year_levels to be an array, but got:",e.year_levels);return}e.year_levels.forEach((o,p)=>{let _=o.year_level,f=`yearLevel${_}`,x=`curriculumVersion${_}`;a.push({label:`Year Level ${_}`,formControlName:f,type:"text",required:!0,disabled:!0}),a.push({label:"Curriculum Year",formControlName:x,type:"select",options:n.map(E=>E.year),required:!0})});let r=a.reduce((o,p)=>{if(p.type==="text")o[p.formControlName]=p.label.replace("Year Level ","");else if(p.type==="select"){let _=parseInt(p.formControlName.replace("curriculumVersion",""),10),f=d.find(x=>x.year_level===_);o[p.formControlName]=f?f.curriculum_year:""}return o},{});this.dialog.open(w,{data:{title:`Manage ${e.program_code} Year Levels`,fields:a,isEdit:!0,initialValue:r,useHorizontalLayout:!0},disableClose:!0}).afterClosed().subscribe(o=>{if(o){if(!Array.isArray(e.year_levels)){console.error("Expected year_levels to be an array after dialog close.");return}let p=e.year_levels.map(_=>{let f=`curriculumVersion${_.year_level}`,x=o[f],E=t.find(ge=>ge.curriculum_year===x);return L(B({},_),{curriculum_year:x,curriculum_id:E?E.curriculum_id:_.curriculum_id})});this.selectedAcademicYearId!=null?this.schedulingService.updateYearLevelsCurricula(this.selectedAcademicYearId,e.program_id,p).subscribe(_=>{this.snackBar.open("Year levels updated successfully.","Close",{duration:3e3}),this.fetchProgramsForAcademicYear(this.selectedAcademicYear)},_=>{console.error("Failed to update year levels:",_)}):console.error("selectedAcademicYearId is null or undefined.")}})})}onManageSections(e){let a=[],t=e.year_levels.sort((r,m)=>r.year_level-m.year_level);if(!Array.isArray(t)){console.error("Expected year_levels to be an array, but got:",t);return}t.forEach(r=>{let m=`yearLevel${r.year_level}`,o=`numberOfSections${r.year_level}`;a.push({label:`Year Level ${r.year_level}`,formControlName:m,type:"text",required:!0,disabled:!0}),a.push({label:"Number of Sections",formControlName:o,type:"number",required:!0,min:1})});let n=a.reduce((r,m)=>{if(m.type==="text")r[m.formControlName]=m.label.replace("Year Level ","");else if(m.type==="number"){let o=parseInt(m.formControlName.replace("numberOfSections",""),10);r[m.formControlName]=e.sections[o.toString()]||1}return r},{});this.dialog.open(w,{data:{title:`Manage ${e.program_code} Sections`,fields:a,isEdit:!0,initialValue:n,useHorizontalLayout:!0},disableClose:!0}).afterClosed().subscribe(r=>{if(r){let m=!1;t.forEach(o=>{let p=`numberOfSections${o.year_level}`,_=r[p];_!==e.sections[o.year_level.toString()]&&(m=!0,this.selectedAcademicYearId!=null?this.schedulingService.updateSections(this.selectedAcademicYearId,e.program_id,o.year_level,_).subscribe(f=>{console.log(`Year Level ${o.year_level} updated successfully.`)},f=>{console.error(`Failed to update Year Level ${o.year_level}`,f)}):console.error("selectedAcademicYearId is null or undefined."))}),m?(this.snackBar.open("Sections updated successfully.","Close",{duration:3e3}),this.fetchProgramsForAcademicYear(this.selectedAcademicYear)):this.snackBar.open("No changes detected!","Close",{duration:3e3})}})}onRemoveProgram(e){let a={title:"Confirm Delete",content:`Are you sure you want to delete the program "${e.program_code}"? This action cannot be undone.`,actionText:"Delete",cancelText:"Cancel",action:"Delete"};this.dialog.open(j,{data:a,disableClose:!0,panelClass:"dialog-base"}).afterClosed().subscribe(n=>{n==="Delete"&&(this.selectedAcademicYearId!=null?this.schedulingService.removeProgramFromAcademicYear(this.selectedAcademicYearId,e.program_id).subscribe(d=>{d.status==="success"?(this.programs=this.programs.filter(r=>r.program_id!==e.program_id),this.snackBar.open(d.message,"Close",{duration:3e3}),this.fetchProgramsForAcademicYear(this.selectedAcademicYear)):d.status==="error"&&d.message&&this.snackBar.open(d.message,"Close",{duration:5e3})},d=>{let r="Failed to delete the program. Please try again.";d.error&&d.error.message?r=d.error.message:d.message&&(r=d.message),this.snackBar.open(r,"Close",{duration:5e3})}):(console.error("selectedAcademicYearId is null or undefined."),this.snackBar.open("Invalid academic year selection.","Close",{duration:3e3})))})}openAddAcademicYearDialog(){let e={title:"Add Academic Year",fields:[{label:"Year Start",formControlName:"yearStart",type:"text",required:!0,maxLength:4},{label:"Year End",formControlName:"yearEnd",type:"text",required:!0,maxLength:4}],isEdit:!1,useHorizontalLayout:!0,initialValue:{yearStart:"",yearEnd:""}};this.dialog.open(w,{data:e,disableClose:!0}).afterClosed().subscribe(t=>{t&&t.yearStart&&t.yearEnd&&(this.isValidYear(t.yearStart)&&this.isValidYear(t.yearEnd)?this.schedulingService.addAcademicYear(t.yearStart,t.yearEnd).subscribe(n=>{this.snackBar.open("New academic year added successfully.","Close",{duration:3e3}),this.loadAcademicYears()},n=>{let d=n.message||"Failed to add academic year. Please try again.";this.snackBar.open(d,"Close",{duration:5e3})}):this.snackBar.open("Invalid year format. Please enter valid 4-digit years.","Close",{duration:3e3}))})}isValidYear(e){return/^\d{4}$/.test(e)&&parseInt(e)>1900&&parseInt(e)<2100}academicYearMap={};openManageAcademicYearDialog(){I({academicYears:this.schedulingService.getAcademicYears(),activeDetails:this.schedulingService.getActiveYearAndSemester()}).subscribe({next:({academicYears:e,activeDetails:a})=>{this.academicYearMap={};let n={title:"Manage Academic Years",isManageList:!0,academicYearList:e.map(r=>(this.academicYearMap[r.academic_year]=r.academic_year_id,r.academic_year)),fields:[],isEdit:!1};this.dialog.open(w,{data:n,disableClose:!0}).afterClosed().subscribe(r=>{if(r&&r.deletedYear){let m=this.academicYearMap[r.deletedYear],o=this.academicYearMap[a.activeYear];m===o?this.snackBar.open("Cannot delete the current set active academic year.","Close",{duration:3e3}):this.deleteAcademicYear(m)}})},error:e=>{console.error("Error fetching academic years:",e),this.snackBar.open("Failed to fetch academic years.","Close",{duration:3e3})}})}deleteAcademicYear(e){this.schedulingService.deleteAcademicYear(e).subscribe(a=>{this.snackBar.open("Academic year deleted successfully.","Close",{duration:3e3}),this.loadAcademicYears()},a=>{console.error("Error deleting academic year:",a),this.snackBar.open("Failed to delete academic year.","Close",{duration:3e3})})}handleError(e){return a=>{console.error(`${e}:`,a)}}static \u0275fac=function(a){return new(a||i)(M(K),M(me),M(_e),M(pe))};static \u0275cmp=F({type:i,selectors:[["app-academic-year"]],standalone:!0,features:[N],decls:3,vars:1,consts:[[1,"academic-year-container"],[1,"loading-wrapper"],[1,"academic-year-header-container"],[3,"inputChange","add","addAcademicYear","inputFields","showExportButton","showAddButton","addButtonLabel","addIconName","showActiveYearAndSem","showButtons","selectedValues"],[1,"academic-year-table-container"],[1,"table-container"],["mat-table","",1,"custom-table",3,"dataSource"],["matColumnDef","index"],["mat-header-cell","","class","custom-header index",4,"matHeaderCellDef"],["mat-cell","","class","index",4,"matCellDef"],["matColumnDef","program_code"],["mat-header-cell","","class","custom-header",4,"matHeaderCellDef"],["mat-cell","","class","custom-cell",4,"matCellDef"],["matColumnDef","program_title"],["matColumnDef","year_levels"],["matColumnDef","sections"],["matColumnDef","action"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],[4,"matNoDataRow"],["mat-header-cell","",1,"custom-header","index"],["mat-cell","",1,"index"],["mat-header-cell","",1,"custom-header"],["mat-cell","",1,"custom-cell"],["mat-button","",1,"edit-button",3,"click"],["mat-button","",1,"remove-button",3,"click"],["mat-header-row",""],["mat-row",""],[1,"no-data-cell"],[1,"flex-cell"],[1,"no-data-text"],["mat-symbol","info"]],template:function(a,t){a&1&&(c(0,"div",0),h(1,he,2,0,"div",1)(2,Ie,26,15),l()),a&2&&(g(),$(t.isLoading?1:2))},dependencies:[H,ue,le,W,Z,ie,ee,X,ne,te,ae,re,oe,ce,U,z,de,se,G,q],styles:["*[_ngcontent-%COMP%]{margin:0;padding:0;border:0;box-sizing:border-box}.academic-year-container[_ngcontent-%COMP%]{transition:background-color .3s ease;display:flex;flex-direction:column;align-items:none;justify-content:none;gap:var(--spacing-md);height:100%}.academic-year-table-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:none;justify-content:none;gap:0;-ms-overflow-style:none;scrollbar-width:none;overflow:auto;position:relative;border-radius:var(--border-radius-md)}.academic-year-table-container[_ngcontent-%COMP%]::-webkit-scrollbar{display:none}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]{-ms-overflow-style:none;scrollbar-width:none;display:flex;flex-direction:column;background-color:var(--neutral-light);max-height:50rem}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]::-webkit-scrollbar{display:none}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .custom-table[_ngcontent-%COMP%]{transition:background-color .3s ease;background-color:var(--neutral-light)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .custom-table[_ngcontent-%COMP%]   .table-button[_ngcontent-%COMP%]{color:var(--primary-text)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .index[_ngcontent-%COMP%]{padding:0 var(--spacing-md)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .custom-header[_ngcontent-%COMP%]{text-wrap:nowrap;background-color:var(--primary-one);color:#fff;font-weight:500;text-align:center;position:sticky;top:0;z-index:2}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .custom-cell[_ngcontent-%COMP%]{padding:var(--spacing-sm);text-align:center}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .custom-cell[_ngcontent-%COMP%]   .edit-button[_ngcontent-%COMP%]{color:var(--secondary-text)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .custom-cell[_ngcontent-%COMP%]   .edit-button[_ngcontent-%COMP%]:hover{background-color:var(--secondary-hover)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .custom-cell[_ngcontent-%COMP%]   .remove-button[_ngcontent-%COMP%]{color:var(--primary-text)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .custom-cell[_ngcontent-%COMP%]   .remove-button[_ngcontent-%COMP%]:hover{background-color:var(--primary-hover)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .no-data-cell[_ngcontent-%COMP%]{text-align:center;padding:var(--spacing-lg)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .no-data-cell[_ngcontent-%COMP%]   .flex-cell[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center;justify-content:center;gap:var(--spacing-xs)}.academic-year-table-container[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .no-data-cell[_ngcontent-%COMP%]   .flex-cell[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{opacity:var(--opacity-semi-opaque)}"],data:{animation:[J,Q]}})}return i})();export{Ze as AcademicYearComponent};
