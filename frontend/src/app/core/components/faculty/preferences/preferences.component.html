<div class="faculty-preferences-container">
  @if(isLoading) {
  <div class="loading-wrapper">
    <app-loading></app-loading>
  </div>
  } @else { @if (!isPreferencesEnabled) {
  <div class="overlay" (click)="onDisabledSectionClick($event)"></div>
  }
  <!-- Preferences First Row -->
  <div class="preferences-row-one">
    <div id="preferences_title" [@fadeAnimation]>
      <h1>Set Preferences</h1>
      <p class="pref-description">
        Submit your preferred courses and schedule for the upcoming semester.
      </p>
    </div>

    <div id="units_container" [class.disabled]="!isPreferencesEnabled">
      <div class="units max" [@fadeAnimation]>
        <h2>{{ maxUnits }}</h2>
        <span>Max. Units Allowed</span>
      </div>
      <div class="units total" [@fadeAnimation]>
        <h2>{{ units }}</h2>
        <span>Total Units Selected</span>
      </div>
    </div>
  </div>
  <!-- Preferences Second Row -->
  <div
    class="preferences-row-two"
    [class.disabled]="!isPreferencesEnabled"
    (click)="onDisabledSectionClick($event)"
  >
    <!-- Courses List -->
    <div id="courses_container" [@fadeAnimation]>
      <div id="courses_search">
        <mat-form-field appearance="fill" class="custom-mat-search">
          <mat-label>Search</mat-label>
          <input
            matInput
            maxlength="50"
            [(ngModel)]="searchQuery"
            (input)="onSearchInput()"
            #searchInput
          />
          <span mat-symbol="search" matPrefix></span>
          @if (searchQuery) {
          <button mat-icon-button matSuffix (click)="clearSearch()">
            <mat-icon>close</mat-icon>
          </button>
          } @if (!showProgramSelection && !searchQuery) {
          <button mat-icon-button [matMenuTriggerFor]="filterMenu" matSuffix>
            <mat-icon>filter_list</mat-icon>
          </button>
          }
        </mat-form-field>
      </div>

      <mat-menu #filterMenu="matMenu">
        @for (year of dynamicYearLevels; track year) {
        <button mat-menu-item (click)="filterByYear(year)">
          Year Level: {{ year }}
        </button>
        }
        <!-- Clear filter option -->
        <button mat-menu-item (click)="filterByYear(null)">Clear Filter</button>
      </mat-menu>

      <!-- Add this block after the search input -->
      @if (searchQuery && filteredSearchResults.length === 0) {
      <div id="empty-results">
        <span mat-symbol="search_off"></span>
        <span class="results-desc"
          >No results found for "{{ searchQuery }}"</span
        >
      </div>
      } @else if (searchQuery && filteredSearchResults.length > 0) {
      <div id="search_results">
        <h3 class="cards-label">
          <span mat-symbol="manage_search"></span>Search Results
        </h3>
        <div class="courses-scroll-container">
          <div [@cardEntranceAnimation]="filteredSearchResults.length">
            @for (course of filteredSearchResults; track course.course_id) {
            <div
              class="course-card pop"
              matRipple
            >
              <div class="course-info">
                <span class="course-code">{{ course.course_code }}</span>
                <span class="course-title">{{ course.course_title }}</span>
              </div>
              <button
                mat-icon-button
                class="add-button"
                (click)="addCourseToTable(course)"
              >
                <span mat-symbol="add" variant="outlined" size="20px"></span>
              </button>
            </div>
            }
          </div>
        </div>
      </div>
      } @if (showProgramSelection && !searchQuery) {
      <div id="programs_list">
        <h3 class="cards-label">
          <span mat-symbol="school"></span>Select a Program
        </h3>
        <div class="programs-scroll-container">
          <div [@cardEntranceAnimation]="programs.length">
            @for (program of programs; track trackByProgramId($index, program)){
            <div
              class="program-card pop"
              (click)="selectProgram(program)"
              matRipple
            >
              <div class="program-info">
                <span class="program-code">{{ program.program_code }}</span>
                <span class="program-title">{{ program.program_title }}</span>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      } @else if (!showProgramSelection && !searchQuery) {
      <div id="courses_list">
        <h3 class="cards-label">
          <span
            class="arrow_back"
            mat-symbol="arrow_back"
            (click)="backToProgramSelection()"
          ></span>
          Select {{ selectedProgram?.program_code }} Courses
        </h3>
        <div class="courses-scroll-container">
          <div [@cardEntranceAnimation]="filteredCourses.length">
            @for (course of filteredCourses; track trackByCourseId($index,
            course)) {
            <div
              class="course-card pop"
              matRipple
            >
              <div class="course-info">
                <span class="course-code">{{ course.course_code }}</span>
                <span class="course-title">{{ course.course_title }}</span>
              </div>
              <button
                mat-icon-button
                class="add-button"
                (click)="addCourseToTable(course)"
              >
                <span mat-symbol="add" variant="outlined" size="20px"></span>
              </button>
            </div>
            }
          </div>
        </div>
      </div>
      }
    </div>

    <!-- Preferences Table -->
    <div id="table_container" [@fadeAnimation]>
      <table
        mat-table
        [dataSource]="dataSource"
        class="table-main"
        class="mat-elevation-z0"
      >
        <!-- Action Column -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef class="table-header"></th>
          <td mat-cell *matCellDef="let element" class="table-cell">
            <button
              mat-icon-button
              class="remove-button"
              (click)="removeCourse(element)"
            >
              <span mat-symbol="do_not_disturb_on" variant="outlined"></span>
            </button>
          </td>
        </ng-container>
        <!-- # Column -->
        <ng-container matColumnDef="num">
          <th mat-header-cell *matHeaderCellDef class="table-header">#</th>
          <td
            mat-cell
            *matCellDef="let element; let i = index"
            class="table-cell"
          >
            {{ i + 1 }}
          </td>
        </ng-container>

        <ng-container matColumnDef="course_code">
          <th mat-header-cell *matHeaderCellDef class="table-header">
            Course Code
          </th>
          <td mat-cell *matCellDef="let element" class="table-cell">
            {{ element.course_code }}
          </td>
        </ng-container>

        <ng-container matColumnDef="course_title">
          <th mat-header-cell *matHeaderCellDef class="table-header">
            Course Title
          </th>
          <td mat-cell *matCellDef="let element" class="table-cell title-cell">
            {{ element.course_title }}
          </td>
        </ng-container>

        <ng-container matColumnDef="lec_hours">
          <th mat-header-cell *matHeaderCellDef class="table-header">Lec</th>
          <td mat-cell *matCellDef="let element" class="table-cell">
            {{ element.lec_hours }}
          </td>
        </ng-container>

        <ng-container matColumnDef="lab_hours">
          <th mat-header-cell *matHeaderCellDef class="table-header">Lab</th>
          <td mat-cell *matCellDef="let element" class="table-cell">
            {{ element.lab_hours }}
          </td>
        </ng-container>

        <ng-container matColumnDef="units">
          <th mat-header-cell *matHeaderCellDef class="table-header">Units</th>
          <td mat-cell *matCellDef="let element" class="table-cell">
            {{ element.units }}
          </td>
        </ng-container>

        <!-- Preferred Day Column -->
        <ng-container matColumnDef="preferredDay">
          <th mat-header-cell *matHeaderCellDef class="table-header">
            Preferred Day
          </th>
          <td mat-cell *matCellDef="let element" class="table-cell">
            <button
              mat-button
              (click)="openDayDialog(element)"
              class="preferred-button day"
            >
              <mat-icon fontSet="material-icons-round" class="preferred-icon"
                >calendar_today</mat-icon
              >
              {{ element.preferredDay ? element.preferredDay : "Select day" }}
            </button>
          </td>
        </ng-container>

        <!-- Preferred Time Column -->
        <ng-container matColumnDef="preferredTime">
          <th mat-header-cell *matHeaderCellDef class="table-header">
            Preferred Time
          </th>
          <td mat-cell *matCellDef="let element" class="table-cell">
            <button
              mat-button
              (click)="openTimeDialog(element)"
              class="preferred-button time"
            >
              <mat-icon fontSet="material-icons-round">schedule</mat-icon>
              <span class="display-time">
                {{
                  element.preferredTime === "Whole Day"
                    ? "Whole Day"
                    : element.preferredTime
                    ? (element.preferredTime | timeFormat)
                    : "Select time"
                }}
              </span>
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          [@rowAdditionAnimation]
        ></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="9">
            <div class="no-data-text" [@fadeAnimation]>
              <span mat-symbol="info"></span>
              <span>No preferences added yet.</span>
            </div>
          </td>
        </tr>
      </table>

      <!--Table Pseudo Footer-->
      <div class="table-footer">
        <!-- Remove All Button -->
        <div
          class="button-container"
          (click)="!isRemoveDisabled && removeAllCourses()"
          [matTooltip]="
            isRemoveDisabled ? 'You must select at least one course.' : ''
          "
          [class.disabled]="isRemoveDisabled"
        >
          <span mat-symbol="delete_sweep" class="remove"></span>
          <span class="button-text remove">Remove all</span>
        </div>

        <!-- Submit Preferences Button -->
        <div
          class="button-container"
          (click)="!isSubmitDisabled && submitPreferences()"
          [matTooltip]="
            isSubmitDisabled
              ? 'Select one or more courses, ensuring each has a preferred day and time.'
              : ''
          "
          [class.disabled]="isSubmitDisabled"
        >
          <span class="button-text submit">Submit Preferences</span>
          <span mat-symbol="done_all" class="submit"></span>
        </div>
      </div>
    </div>
  </div>
  }
</div>
